<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Floppy Bird üê¶</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 70%, #98D98E 70%, #98D98E 100%);
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #gameContainer {
            position: relative;
            width: 90vw;
            height: 90vh;
            max-width: 800px;
            max-height: 900px;
            border: 3px solid #333;
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 80%, #98D98E 80%, #98D98E 100%);
            overflow: hidden;
            cursor: pointer;
            transition: background 2s ease-in-out;
        }

        /* Day/Night backgrounds */
        #gameContainer.day {
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 80%, #98D98E 80%, #98D98E 100%);
        }

        #gameContainer.dawn {
            background: linear-gradient(to bottom, #FFB347 0%, #FFB347 80%, #98D98E 80%, #98D98E 100%);
        }

        #gameContainer.dusk {
            background: linear-gradient(to bottom, #FF6B6B 0%, #4ECDC4 80%, #556B2F 80%, #556B2F 100%);
        }

        #gameContainer.night {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 80%, #2C3E50 80%, #2C3E50 100%);
        }

        /* Seasonal ground colors */
        #gameContainer.spring {
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 80%, #90EE90 80%, #90EE90 100%);
        }

        #gameContainer.summer {
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 80%, #98D98E 80%, #98D98E 100%);
        }

        #gameContainer.autumn {
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 80%, #D2691E 80%, #D2691E 100%);
        }

        #gameContainer.winter {
            background: linear-gradient(to bottom, #87CEEB 0%, #87CEEB 80%, #F0F8FF 80%, #F0F8FF 100%);
        }

        /* Night variants for seasons */
        #gameContainer.night.spring {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 80%, #2d4a2b 80%, #2d4a2b 100%);
        }

        #gameContainer.night.summer {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 80%, #2C3E50 80%, #2C3E50 100%);
        }

        #gameContainer.night.autumn {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 80%, #4a2c2a 80%, #4a2c2a 100%);
        }

        #gameContainer.night.winter {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 80%, #3d4a5c 80%, #3d4a5c 100%);
        }

        /* Dawn/Dusk variants for seasons */
        #gameContainer.dawn.spring {
            background: linear-gradient(to bottom, #FFB347 0%, #FFB347 80%, #90EE90 80%, #90EE90 100%);
        }

        #gameContainer.dawn.summer {
            background: linear-gradient(to bottom, #FFB347 0%, #FFB347 80%, #98D98E 80%, #98D98E 100%);
        }

        #gameContainer.dawn.autumn {
            background: linear-gradient(to bottom, #FFB347 0%, #FFB347 80%, #D2691E 80%, #D2691E 100%);
        }

        #gameContainer.dawn.winter {
            background: linear-gradient(to bottom, #FFB347 0%, #FFB347 80%, #F0F8FF 80%, #F0F8FF 100%);
        }

        #gameContainer.dusk.spring {
            background: linear-gradient(to bottom, #FF6B6B 0%, #4ECDC4 80%, #90EE90 80%, #90EE90 100%);
        }

        #gameContainer.dusk.summer {
            background: linear-gradient(to bottom, #FF6B6B 0%, #4ECDC4 80%, #556B2F 80%, #556B2F 100%);
        }

        #gameContainer.dusk.autumn {
            background: linear-gradient(to bottom, #FF6B6B 0%, #4ECDC4 80%, #D2691E 80%, #D2691E 100%);
        }

        #gameContainer.dusk.winter {
            background: linear-gradient(to bottom, #FF6B6B 0%, #4ECDC4 80%, #F0F8FF 80%, #F0F8FF 100%);
        }

        #bird {
            position: absolute;
            font-size: 50px;
            left: 15%;
            transition: transform 0.1s linear; /* Changed to linear for direct correlation */
            user-select: none;
            transform: scaleX(-1); /* Flip the bird to face right */
        }

        /* Weather effects */
        .weather-particle {
            position: absolute;
            user-select: none;
            pointer-events: none;
            z-index: 50;
        }

        .raindrop {
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, transparent, #4FC3F7);
            animation: fall 1s linear infinite;
        }

        .snowflake {
            font-size: 20px;
            color: white;
            animation: snowfall 3s linear infinite;
        }

        .leaf {
            font-size: 25px;
            animation: leaffall 4s ease-in-out infinite;
        }

        .flower {
            font-size: 20px;
            animation: flowerfall 5s ease-in-out infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh);
            }
        }

        @keyframes snowfall {
            to {
                transform: translateY(100vh) translateX(50px) rotate(360deg);
            }
        }

        @keyframes leaffall {
            to {
                transform: translateY(100vh) translateX(100px) rotate(720deg);
            }
        }

        @keyframes flowerfall {
            to {
                transform: translateY(100vh) translateX(-50px) rotate(-360deg);
            }
        }

        /* New pipe styles - direct elements instead of CSS pseudo-elements */
        .pipe-body {
            position: absolute;
            background: linear-gradient(to right, #228B22, #006400);
            border: 2px solid #004d00;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .pipe-cap {
            position: absolute;
            background: linear-gradient(to right, #228B22, #006400);
            border: 2px solid #004d00;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        /* Debug hitbox visualization */
        .debug-hitbox {
            position: absolute;
            border: 2px solid red;
            background: rgba(255,0,0,0.2);
            pointer-events: none;
            z-index: 1000;
        }

        .debug-hitbox.bird-hitbox {
            border-radius: 50%; /* Round hitbox for bird */
        }

        #score {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 60px;
            font-weight: bold;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
            z-index: 100;
            user-select: none;
        }

        #environmentInfo {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
            user-select: none;
        }

        #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            display: none;
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.4);
            z-index: 200;
        }

        #gameOver h2 {
            margin: 0 0 20px 0;
            font-size: 48px;
            color: #333;
        }

        #gameOver p {
            margin: 15px 0;
            font-size: 28px;
            color: #666;
        }

        #gameOver button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #gameOver button:hover {
            background: #45a049;
        }

        #startScreen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(255,255,255,0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.4);
            z-index: 200;
        }

        #startScreen h1 {
            margin: 0 0 20px 0;
            font-size: 48px;
            color: #333;
        }

        #startScreen p {
            margin: 20px 0;
            font-size: 22px;
            color: #666;
        }

        #startScreen button {
            padding: 15px 40px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        #startScreen button:hover {
            background: #45a049;
        }

        .cloud {
            position: absolute;
            font-size: 60px;
            opacity: 0.6;
            user-select: none;
            transition: opacity 2s ease-in-out;
        }

        .night .cloud {
            opacity: 0.3;
        }

        #cloud1 {
            top: 10%;
            animation: moveCloud 30s linear infinite;
        }

        #cloud2 {
            top: 25%;
            animation: moveCloud 40s linear infinite;
            animation-delay: -15s;
        }

        #cloud3 {
            top: 15%;
            animation: moveCloud 35s linear infinite;
            animation-delay: -25s;
        }

        @keyframes moveCloud {
            from {
                left: 100%;
            }
            to {
                left: -15%;
            }
        }

        /* Stars for night */
        .star {
            position: absolute;
            color: white;
            font-size: 10px;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            animation: twinkle 3s ease-in-out infinite;
        }

        .night .star {
            opacity: 1;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Developer Options Menu */
        #devMenu {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1100;
            min-width: 200px;
            display: none;
        }

        #devMenu h3 {
            margin: 0 0 15px 0;
            font-size: 16px;
            border-bottom: 1px solid #555;
            padding-bottom: 8px;
        }

        #devMenuToggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            z-index: 1050;
            transition: background 0.3s;
        }

        #devMenuToggle:hover {
            background: rgba(0, 0, 0, 0.8);
        }

        .dev-option {
            margin: 10px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .dev-option label {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-left: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .dev-stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #555;
            font-size: 12px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div id="gameContainer" class="day summer">
        <button id="devMenuToggle" onclick="toggleDevMenu()">‚öôÔ∏è Dev</button>
        
        <div id="devMenu">
            <h3>üõ†Ô∏è Developer Options</h3>
            <div class="dev-option">
                <label for="hitboxToggle">Show Hitboxes</label>
                <label class="switch">
                    <input type="checkbox" id="hitboxToggle" onchange="toggleHitboxes()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="dev-stats" id="devStats">
                <div>FPS: <span id="fpsCounter">0</span></div>
                <div>Bird Y: <span id="birdYPos">0</span></div>
                <div>Velocity: <span id="birdVelocity">0</span></div>
                <div>Rotation: <span id="birdRotation">0</span>¬∞</div>
                <div>Pipes: <span id="pipeCount">0</span></div>
                <div>Pipe Speed: <span id="pipeSpeedDisplay">0</span></div>
                <div>Pipe Gap: <span id="pipeGapDisplay">0</span>px</div>
            </div>
        </div>

        <div id="environmentInfo">‚òÄÔ∏è Summer Day</div>
        
        <!-- Stars for night time -->
        <div class="star" style="top: 20%; left: 10%;">‚ú¶</div>
        <div class="star" style="top: 30%; left: 25%;">‚ú¶</div>
        <div class="star" style="top: 15%; left: 40%;">‚ú¶</div>
        <div class="star" style="top: 25%; left: 60%;">‚ú¶</div>
        <div class="star" style="top: 35%; left: 75%;">‚ú¶</div>
        <div class="star" style="top: 10%; left: 85%;">‚ú¶</div>
        <div class="star" style="top: 40%; left: 50%;">‚ú¶</div>
        <div class="star" style="top: 20%; left: 90%;">‚ú¶</div>

        <div id="cloud1" class="cloud">‚òÅÔ∏è</div>
        <div id="cloud2" class="cloud">‚òÅÔ∏è</div>
        <div id="cloud3" class="cloud">‚òÅÔ∏è</div>
        <div id="score">0</div>
        <div id="bird">üê¶</div>
        
        <div id="startScreen">
            <h1>Emoji Floppy Bird üê¶</h1>
            <p>Click or press Space to flap!</p>
            <p>Avoid the pipes! üöß</p>
            <button onclick="startGame()">Start Game</button>
        </div>
        
        <div id="gameOver">
            <h2>Game Over! üí•</h2>
            <p>Your Score: <span id="finalScore">0</span></p>
            <p>Best Score: <span id="bestScore">0</span></p>
            <button onclick="resetGame()">Play Again</button>
        </div>
    </div>

    <script>
        // Game variables
        let bird = document.getElementById('bird');
        let gameContainer = document.getElementById('gameContainer');
        let scoreElement = document.getElementById('score');
        let gameOverScreen = document.getElementById('gameOver');
        let startScreen = document.getElementById('startScreen');
        let finalScoreElement = document.getElementById('finalScore');
        let bestScoreElement = document.getElementById('bestScore');
        let environmentInfo = document.getElementById('environmentInfo');

        // Developer menu elements
        let devMenu = document.getElementById('devMenu');
        let hitboxToggle = document.getElementById('hitboxToggle');
        let showHitboxes = false;

        // FPS counter variables
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let fps = 0;

        // Get container dimensions
        let containerWidth = gameContainer.offsetWidth;
        let containerHeight = gameContainer.offsetHeight;

        // Bird physics - adjusted for higher arc flapping
        let birdY = containerHeight / 2;
        let velocity = 0;
        let gravity = 0.2; // Reduced from 0.3 for more floaty feel
        let jumpPower = -5; // Reduced from -7.5 for more gradual acceleration
        let maxVelocity = 8;
        let currentRotation = 0;
        
        // Game variables
        let score = 0;
        let bestScore = localStorage.getItem('floppyBirdBestScore') || 0;
        let gameRunning = false;
        let pipes = [];
        let pipeGap = 165;
        let pipeSpeed = containerWidth * 0.0045;
        let pipeInterval = 3000;
        let lastPipeTime = 0;
        let animationId;

        // Environment variables
        let currentSeason = 'summer';
        let currentTimeOfDay = 'day';
        let isWeatherActive = false;
        let weatherType = null;
        let weatherParticles = [];
        let gameStartTime = 0;
        let lastEnvironmentUpdate = 0;

        // Seasons and times of day
        const seasons = ['spring', 'summer', 'autumn', 'winter'];
        const timesOfDay = ['dawn', 'day', 'dusk', 'night'];
        const weatherTypes = {
            spring: ['rain', 'flowers'],
            summer: ['clear', 'rain'],
            autumn: ['leaves', 'rain'],
            winter: ['snow', 'clear']
        };

        const seasonEmojis = {
            spring: 'üå∏',
            summer: '‚òÄÔ∏è',
            autumn: 'üçÇ',
            winter: '‚ùÑÔ∏è'
        };

        const timeEmojis = {
            dawn: 'üåÖ',
            day: '‚òÄÔ∏è',
            dusk: 'üåÜ',
            night: 'üåô'
        };

        // Timing constants
        const DAY_NIGHT_CYCLE_TIME = 30000; // 30 seconds per time period (2 minutes for full cycle)
        const SEASON_CHANGE_INTERVAL = 100; // Change season every 100 points

        // Pipe dimensions - exact sizes for hitboxes
        const PIPE_WIDTH = 80;
        const PIPE_CAP_WIDTH = 100;
        const PIPE_CAP_HEIGHT = 40;
        const PIPE_CAP_OFFSET = (PIPE_CAP_WIDTH - PIPE_WIDTH) / 2;

        // Bird hitbox offset - moved 8px down and 8px right
        const BIRD_HITBOX_OFFSET_X = 8;
        const BIRD_HITBOX_OFFSET_Y = 8;
        const BIRD_RADIUS = 22.5;

        // Initialize best score display
        bestScoreElement.textContent = bestScore;

        // Toggle developer menu
        function toggleDevMenu() {
            if (devMenu.style.display === 'block') {
                devMenu.style.display = 'none';
            } else {
                devMenu.style.display = 'block';
            }
        }

        // Toggle hitbox visibility
        function toggleHitboxes() {
            showHitboxes = hitboxToggle.checked;
            if (!showHitboxes) {
                document.querySelectorAll('.debug-hitbox').forEach(box => box.remove());
            }
        }

        // Update developer stats
        function updateDevStats() {
            frameCount++;
            let currentTime = performance.now();
            if (currentTime - lastFrameTime >= 1000) {
                fps = frameCount;
                frameCount = 0;
                lastFrameTime = currentTime;
                document.getElementById('fpsCounter').textContent = fps;
            }

            document.getElementById('birdYPos').textContent = Math.round(birdY);
            document.getElementById('birdVelocity').textContent = velocity.toFixed(2);
            document.getElementById('birdRotation').textContent = Math.round(currentRotation);
            document.getElementById('pipeCount').textContent = pipes.length;
            document.getElementById('pipeSpeedDisplay').textContent = pipeSpeed.toFixed(4);
            document.getElementById('pipeGapDisplay').textContent = pipeGap;
        }

        // Bird rotation based on velocity - more gradual
        function updateBirdRotation() {
            // More gradual rotation based on velocity
            // Scale down the velocity impact for smoother rotation
            let normalizedVelocity = velocity / maxVelocity;
            
            // Apply a smoother curve to the rotation
            // Use a power function to make the rotation more gradual
            let rotationFactor = Math.sign(normalizedVelocity) * Math.pow(Math.abs(normalizedVelocity), 0.7);
            let rotation = -rotationFactor * 60; // Reduced from 80 to 60 for less extreme angles
            
            // Clamp rotation to desired range
            rotation = Math.max(-50, Math.min(60, rotation)); // Reduced range for more control
            
            currentRotation = rotation;
            bird.style.transform = `scaleX(-1) rotate(${rotation}deg)`;
        }

        // Update environment based on time and score
        function updateEnvironment(currentTime) {
            // Time-based day/night cycle
            let timeSinceStart = currentTime - gameStartTime;
            let dayNightCycle = Math.floor(timeSinceStart / DAY_NIGHT_CYCLE_TIME) % 4;
            let newTimeOfDay = timesOfDay[dayNightCycle];
            
            // Score-based season change
            let seasonCycle = Math.floor(score / SEASON_CHANGE_INTERVAL) % 4;
            let newSeason = seasons[seasonCycle];
            
            // Update if changed
            if (newTimeOfDay !== currentTimeOfDay || newSeason !== currentSeason) {
                let environmentChanged = false;
                
                if (newTimeOfDay !== currentTimeOfDay) {
                    currentTimeOfDay = newTimeOfDay;
                    environmentChanged = true;
                }
                
                if (newSeason !== currentSeason) {
                    currentSeason = newSeason;
                    environmentChanged = true;
                }
                
                if (environmentChanged) {
                    // Update classes
                    gameContainer.className = `${currentTimeOfDay} ${currentSeason}`;
                    
                    // Update info display
                    let timeEmoji = timeEmojis[currentTimeOfDay];
                    let seasonEmoji = seasonEmojis[currentSeason];
                    let seasonName = currentSeason.charAt(0).toUpperCase() + currentSeason.slice(1);
                    let timeName = currentTimeOfDay.charAt(0).toUpperCase() + currentTimeOfDay.slice(1);
                    
                    environmentInfo.textContent = `${timeEmoji} ${seasonName} ${timeName}`;
                    
                    // Trigger weather event on time change (not just season change)
                    if (Math.random() < 0.5) { // 50% chance of weather on any environment change
                        startWeatherEvent();
                    }
                }
            }
        }

        // Start weather event
        function startWeatherEvent() {
            if (isWeatherActive) return;
            
            let possibleWeather = weatherTypes[currentSeason];
            weatherType = possibleWeather[Math.floor(Math.random() * possibleWeather.length)];
            
            if (weatherType === 'clear') return;
            
            isWeatherActive = true;
            
            // Create weather particles
            for (let i = 0; i < 30; i++) {
                setTimeout(() => createWeatherParticle(), i * 100);
            }
            
            // Stop weather after 10-20 seconds
            setTimeout(stopWeatherEvent, 10000 + Math.random() * 10000);
        }

        // Stop weather event
        function stopWeatherEvent() {
            isWeatherActive = false;
            weatherType = null;
        }

        // Create weather particle
        function createWeatherParticle() {
            if (!isWeatherActive) return;
            
            let particle = document.createElement('div');
            particle.className = 'weather-particle';
            
            switch (weatherType) {
                case 'rain':
                    particle.className += ' raindrop';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDuration = (0.5 + Math.random() * 0.5) + 's';
                    break;
                    
                case 'snow':
                    particle.className += ' snowflake';
                    particle.innerHTML = '‚ùÑÔ∏è';
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                    break;
                    
                case 'leaves':
                    particle.className += ' leaf';
                    particle.innerHTML = ['üçÅ', 'üçÇ', 'üçÉ'][Math.floor(Math.random() * 3)];
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDuration = (3 + Math.random() * 2) + 's';
                    break;
                    
                case 'flowers':
                    particle.className += ' flower';
                    particle.innerHTML = ['üå∏', 'üåº', 'üå∫'][Math.floor(Math.random() * 3)];
                    particle.style.left = Math.random() * 100 + '%';
                    particle.style.animationDuration = (4 + Math.random() * 2) + 's';
                    break;
            }
            
            gameContainer.appendChild(particle);
            weatherParticles.push(particle);
            
            // Remove particle after animation
            particle.addEventListener('animationend', () => {
                particle.remove();
                weatherParticles = weatherParticles.filter(p => p !== particle);
            });
            
            // Create more particles while weather is active
            if (isWeatherActive) {
                setTimeout(createWeatherParticle, 200 + Math.random() * 800);
            }
        }

        // Create pipe with visual elements matching hitboxes exactly
        function createPipe() {
            let minTopHeight = 100;
            let minBottomHeight = 100;
            let maxTopHeight = containerHeight - pipeGap - minBottomHeight;
            
            if (maxTopHeight <= minTopHeight) {
                maxTopHeight = containerHeight * 0.5;
            }
            
            let pipeHeight = Math.random() * (maxTopHeight - minTopHeight) + minTopHeight;
            
            let pipeContainer = document.createElement('div');
            pipeContainer.style.position = 'absolute';
            pipeContainer.style.left = containerWidth + 'px';
            
            // TOP PIPE
            let topPipeBody = document.createElement('div');
            topPipeBody.className = 'pipe-body';
            topPipeBody.style.width = PIPE_WIDTH + 'px';
            topPipeBody.style.height = pipeHeight + 'px';
            topPipeBody.style.left = '0px';
            topPipeBody.style.top = '0px';
            
            let topPipeCap = document.createElement('div');
            topPipeCap.className = 'pipe-cap';
            topPipeCap.style.width = PIPE_CAP_WIDTH + 'px';
            topPipeCap.style.height = PIPE_CAP_HEIGHT + 'px';
            topPipeCap.style.left = -PIPE_CAP_OFFSET + 'px';
            topPipeCap.style.top = (pipeHeight - PIPE_CAP_HEIGHT) + 'px';
            
            // BOTTOM PIPE
            let bottomPipeY = pipeHeight + pipeGap;
            let bottomPipeHeight = containerHeight - bottomPipeY;
            
            let bottomPipeBody = document.createElement('div');
            bottomPipeBody.className = 'pipe-body';
            bottomPipeBody.style.width = PIPE_WIDTH + 'px';
            bottomPipeBody.style.height = bottomPipeHeight + 'px';
            bottomPipeBody.style.left = '0px';
            bottomPipeBody.style.top = bottomPipeY + 'px';
            
            let bottomPipeCap = document.createElement('div');
            bottomPipeCap.className = 'pipe-cap';
            bottomPipeCap.style.width = PIPE_CAP_WIDTH + 'px';
            bottomPipeCap.style.height = PIPE_CAP_HEIGHT + 'px';
            bottomPipeCap.style.left = -PIPE_CAP_OFFSET + 'px';
            bottomPipeCap.style.top = bottomPipeY + 'px';
            
            pipeContainer.appendChild(topPipeBody);
            pipeContainer.appendChild(topPipeCap);
            pipeContainer.appendChild(bottomPipeBody);
            pipeContainer.appendChild(bottomPipeCap);
            gameContainer.appendChild(pipeContainer);
            
            pipes.push({
                container: pipeContainer,
                passed: false,
                x: containerWidth,
                topHeight: pipeHeight,
                bottomY: bottomPipeY
            });
        }

        // Helper function for circle-rectangle collision
        function circleRectCollision(circleX, circleY, radius, rectX, rectY, rectWidth, rectHeight) {
            let closestX = Math.max(rectX, Math.min(circleX, rectX + rectWidth));
            let closestY = Math.max(rectY, Math.min(circleY, rectY + rectHeight));
            
            let distanceX = circleX - closestX;
            let distanceY = circleY - closestY;
            
            let distanceSquared = (distanceX * distanceX) + (distanceY * distanceY);
            return distanceSquared < (radius * radius);
        }

        // Check collision with circular hitbox
        function checkCollision() {
            let birdCenterX = containerWidth * 0.15 + BIRD_HITBOX_OFFSET_X + BIRD_RADIUS;
            let birdCenterY = birdY + BIRD_HITBOX_OFFSET_Y + BIRD_RADIUS;
            
            if (birdCenterY - BIRD_RADIUS <= 0 || birdCenterY + BIRD_RADIUS >= containerHeight) {
                return true;
            }
            
            for (let pipe of pipes) {
                if (circleRectCollision(birdCenterX, birdCenterY, BIRD_RADIUS, 
                                      pipe.x, 0, PIPE_WIDTH, pipe.topHeight)) {
                    return true;
                }
                
                if (circleRectCollision(birdCenterX, birdCenterY, BIRD_RADIUS, 
                                      pipe.x, pipe.bottomY, PIPE_WIDTH, containerHeight - pipe.bottomY)) {
                    return true;
                }
                
                let topCapY = pipe.topHeight - PIPE_CAP_HEIGHT;
                if (circleRectCollision(birdCenterX, birdCenterY, BIRD_RADIUS, 
                                      pipe.x - PIPE_CAP_OFFSET, topCapY, PIPE_CAP_WIDTH, PIPE_CAP_HEIGHT)) {
                    return true;
                }
                
                if (circleRectCollision(birdCenterX, birdCenterY, BIRD_RADIUS, 
                                      pipe.x - PIPE_CAP_OFFSET, pipe.bottomY, PIPE_CAP_WIDTH, PIPE_CAP_HEIGHT)) {
                    return true;
                }
            }
            
            return false;
        }

        // Draw debug hitboxes
        function drawDebugHitboxes() {
            if (!showHitboxes) return;

            document.querySelectorAll('.debug-hitbox').forEach(box => box.remove());
            
            let birdBox = document.createElement('div');
            birdBox.className = 'debug-hitbox bird-hitbox';
            birdBox.style.left = (containerWidth * 0.15 + BIRD_HITBOX_OFFSET_X) + 'px';
            birdBox.style.top = (birdY + BIRD_HITBOX_OFFSET_Y) + 'px';
            birdBox.style.width = (BIRD_RADIUS * 2) + 'px';
            birdBox.style.height = (BIRD_RADIUS * 2) + 'px';
            birdBox.style.background = 'rgba(0,255,0,0.3)';
            gameContainer.appendChild(birdBox);
            
            pipes.forEach(pipe => {
                let topBox = document.createElement('div');
                topBox.className = 'debug-hitbox';
                topBox.style.left = pipe.x + 'px';
                topBox.style.top = '0px';
                topBox.style.width = PIPE_WIDTH + 'px';
                topBox.style.height = pipe.topHeight + 'px';
                topBox.style.background = 'rgba(255,0,0,0.3)';
                gameContainer.appendChild(topBox);
                
                let topCapBox = document.createElement('div');
                topCapBox.className = 'debug-hitbox';
                topCapBox.style.left = (pipe.x - PIPE_CAP_OFFSET) + 'px';
                topCapBox.style.top = (pipe.topHeight - PIPE_CAP_HEIGHT) + 'px';
                topCapBox.style.width = PIPE_CAP_WIDTH + 'px';
                topCapBox.style.height = PIPE_CAP_HEIGHT + 'px';
                topCapBox.style.background = 'rgba(255,0,0,0.5)';
                gameContainer.appendChild(topCapBox);
                
                let bottomBox = document.createElement('div');
                bottomBox.className = 'debug-hitbox';
                bottomBox.style.left = pipe.x + 'px';
                bottomBox.style.top = pipe.bottomY + 'px';
                bottomBox.style.width = PIPE_WIDTH + 'px';
                bottomBox.style.height = (containerHeight - pipe.bottomY) + 'px';
                bottomBox.style.background = 'rgba(255,0,0,0.3)';
                gameContainer.appendChild(bottomBox);
                
                let bottomCapBox = document.createElement('div');
                bottomCapBox.className = 'debug-hitbox';
                bottomCapBox.style.left = (pipe.x - PIPE_CAP_OFFSET) + 'px';
                bottomCapBox.style.top = pipe.bottomY + 'px';
                bottomCapBox.style.width = PIPE_CAP_WIDTH + 'px';
                bottomCapBox.style.height = PIPE_CAP_HEIGHT + 'px';
                bottomCapBox.style.background = 'rgba(255,0,0,0.5)';
                gameContainer.appendChild(bottomCapBox);
            });
        }

        // Game loop
        function gameLoop(currentTime) {
            if (!gameRunning) return;
            
            velocity += gravity;
            velocity = Math.min(velocity, maxVelocity);
            birdY += velocity;
            bird.style.top = birdY + 'px';
            updateBirdRotation();
            
            // Update environment based on time
            updateEnvironment(currentTime);
            
            if (currentTime - lastPipeTime > pipeInterval) {
                createPipe();
                lastPipeTime = currentTime;
            }
            
            for (let i = pipes.length - 1; i >= 0; i--) {
                let pipe = pipes[i];
                pipe.x -= pipeSpeed;
                pipe.container.style.left = pipe.x + 'px';
                
                if (!pipe.passed && pipe.x + PIPE_WIDTH + PIPE_CAP_OFFSET < containerWidth * 0.15) {
                    pipe.passed = true;
                    score++;
                    scoreElement.textContent = score;
                    // Season might change on score update
                    updateEnvironment(currentTime);
                }
                
                if (pipe.x < -PIPE_CAP_WIDTH) {
                    pipe.container.remove();
                    pipes.splice(i, 1);
                }
            }
            
            updateDevStats();
            drawDebugHitboxes();
            
            if (checkCollision()) {
                endGame();
                return;
            }
            
            animationId = requestAnimationFrame(gameLoop);
        }

        // Jump function
        function jump() {
            if (!gameRunning) return;
            velocity = jumpPower;
        }

        // Start game
        function startGame() {
            startScreen.style.display = 'none';
            gameRunning = true;
            birdY = containerHeight / 2;
            velocity = 0;
            score = 0;
            scoreElement.textContent = score;
            bird.style.top = birdY + 'px';
            
            // Initialize time tracking
            gameStartTime = performance.now();
            lastPipeTime = gameStartTime;
            lastEnvironmentUpdate = gameStartTime;
            
            // Reset environment
            currentSeason = 'summer';
            currentTimeOfDay = 'day';
            gameContainer.className = 'day summer';
            environmentInfo.textContent = '‚òÄÔ∏è Summer Day';
            
            animationId = requestAnimationFrame(gameLoop);
        }

        // End game
        function endGame() {
            gameRunning = false;
            cancelAnimationFrame(animationId);
            finalScoreElement.textContent = score;
            
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('floppyBirdBestScore', bestScore);
                bestScoreElement.textContent = bestScore;
            }
            
            gameOverScreen.style.display = 'block';
            stopWeatherEvent();
        }

        // Reset game
        function resetGame() {
            pipes.forEach(pipe => {
                pipe.container.remove();
            });
            pipes = [];
            
            weatherParticles.forEach(particle => {
                particle.remove();
            });
            weatherParticles = [];
            
            document.querySelectorAll('.debug-hitbox').forEach(box => box.remove());
            
            birdY = containerHeight / 2;
            velocity = 0;
            score = 0;
            scoreElement.textContent = score;
            bird.style.top = birdY + 'px';
            bird.style.transform = 'scaleX(-1) rotate(0deg)';
            
            gameOverScreen.style.display = 'none';
            startGame();
        }

        // Update dimensions on window resize
        window.addEventListener('resize', () => {
            containerWidth = gameContainer.offsetWidth;
            containerHeight = gameContainer.offsetHeight;
            pipeSpeed = containerWidth * 0.0045;
        });

        // Event listeners
        gameContainer.addEventListener('mousedown', (e) => {
            if (e.target.id === 'devMenuToggle' || devMenu.contains(e.target)) {
                return;
            }
            e.preventDefault();
            jump();
        });
        
        gameContainer.addEventListener('touchstart', (e) => {
            if (e.target.id === 'devMenuToggle' || devMenu.contains(e.target)) {
                return;
            }
            e.preventDefault();
            jump();
        });
        
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                jump();
            }
        });

        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target === document.body) {
                e.preventDefault();
            }
        });
    </script>
</body>
</html>
